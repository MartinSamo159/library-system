<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>V√Ωp≈Øjƒçky - Library System</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          background: #f4f6f9;
          margin: 0;
          padding: 20px;
        }
        header {
          background: #007bff;
          color: white;
          padding: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        header nav a, header nav button {
          color: white;
          margin-left: 15px;
          text-decoration: none;
          font-weight: bold;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 1em;
        }
        header nav button:hover, header nav a:hover {
          text-decoration: underline;
        }
        .hidden { display: none; }
        .section {
          margin: 20px 0;
          padding: 15px;
          background: white;
          border-radius: 5px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        th, td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
        }
        th {
          background: #f2f2f2;
        }
        button {
          padding: 6px 12px;
          margin: 3px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }
        .btn-danger { background: #dc3545; color: white; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>
<header>
    <h2>üìö Library System</h2>
    <nav>
        <a href="books.html">Knihy</a>
        <a href="loans.html" id="loans-link">V√Ωp≈Øjƒçky</a>
        <a href="users.html" id="users-link" class="hidden">U≈æivatel√©</a>
        <button onclick="logout()">Odhl√°sit se</button>
    </nav>
</header>

<h2>V√Ωp≈Øjƒçky</h2>

<!-- Formul√°≈ô pro p≈Øjƒçov√°n√≠ (jen ADMIN/LIBRARIAN) -->
<div class="section" id="loanForm" style="display:none;">
    <h3>Nov√° v√Ωp≈Øjƒçka</h3>
    <label>U≈æivatel:</label>
    <select id="userSelect"></select>
    <label>Kniha:</label>
    <select id="bookSelect"></select>
    <button class="btn-success" onclick="createLoan()">P≈Øjƒçit</button>
</div>

<!-- Tabulka v≈°ech v√Ωp≈Øjƒçek -->
<div class="section">
    <h3>Seznam v√Ωp≈Øjƒçek</h3>
    <table id="loans-table">
        <thead>
        <tr>
            <th>ID</th><th>U≈æivatel</th><th>Kniha</th>
            <th>Datum v√Ωp≈Øjƒçky</th><th>Datum vr√°cen√≠</th><th>Akce</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // --- P≈ôihl√°≈°en√≠ ---
    const username = localStorage.getItem("username");
    const password = localStorage.getItem("password");
    if (!username || !password) {
      window.location.href = "login.html";
    }
    const authHeader = "Basic " + btoa(username + ":" + password);

    function logout() {
      localStorage.removeItem("username");
      localStorage.removeItem("password");
      window.location.href = "login.html";
    }

    // --- Naƒçti v√Ωp≈Øjƒçky ---
    function loadLoans() {
      fetch("/loans", { headers: { "Authorization": authHeader } })
        .then(res => res.json())
        .then(loans => {
          const tbody = document.querySelector("#loans-table tbody");
          tbody.innerHTML = "";
          loans.forEach(loan => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${loan.id}</td>
              <td>${loan.user.name}</td>
              <td>${loan.book.title}</td>
              <td>${loan.loanDate}</td>
              <td>${loan.returnDate || ""}</td>
              <td>
                ${!loan.returnDate ? `<button class="btn-danger" onclick="returnLoan(${loan.id})">Vr√°tit</button>` : ""}
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    // --- Vr√°cen√≠ knihy ---
    function returnLoan(loanId) {
      fetch("/loans/" + loanId + "/return", {
        method: "PUT",
        headers: { "Authorization": authHeader }
      })
      .then(res => {
        if (res.ok) {
          alert("‚úÖ Kniha vr√°cena");
          loadLoans();
        } else {
          res.text().then(msg => alert("‚ùå Chyba: " + msg));
        }
      });
    }

    // --- Naƒçti u≈æivatele do selectu ---
    function loadUsers() {
      fetch("/users", { headers: { "Authorization": authHeader } })
        .then(res => res.json())
        .then(users => {
          const select = document.getElementById("userSelect");
          select.innerHTML = "";
          users.forEach(u => {
            const opt = document.createElement("option");
            opt.value = u.id;
            opt.textContent = `${u.name} (${u.email})`;
            select.appendChild(opt);
          });
        });
    }

    // --- Naƒçti knihy do selectu ---
    function loadBooks() {
      fetch("/books?page=0&size=50", { headers: { "Authorization": authHeader } })
        .then(res => res.json())
        .then(data => {
          const books = data.content || data;
          const select = document.getElementById("bookSelect");
          select.innerHTML = "";
          books.forEach(b => {
            const opt = document.createElement("option");
            opt.value = b.id;
            opt.textContent = `${b.title} ‚Äì ${b.author}`;
            select.appendChild(opt);
          });
        });
    }

    // --- Vytvo≈ô v√Ωp≈Øjƒçku ---
    function createLoan() {
      const userId = document.getElementById("userSelect").value;
      const bookId = document.getElementById("bookSelect").value;

      fetch(`/loans?userId=${userId}&bookId=${bookId}`, {
        method: "POST",
        headers: { "Authorization": authHeader }
      })
      .then(res => {
        if (res.ok) {
          alert("‚úÖ V√Ωp≈Øjƒçka vytvo≈ôena");
          loadLoans();
        } else {
          res.text().then(msg => alert("‚ùå Chyba: " + msg));
        }
      });
    }

    // --- Inicializace str√°nky podle role ---
    fetch("/me", { headers: { "Authorization": authHeader } })
      .then(res => res.json())
      .then(user => {
        console.log("P≈ôihl√°≈°en√Ω u≈æivatel:", user);

        // p≈Øjƒçov√°n√≠ ‚Äì pro LIBRARIAN a ADMIN
        if (user.role === "ROLE_LIBRARIAN" || user.role === "ROLE_ADMIN") {
          document.getElementById("loanForm").style.display = "block";
          loadUsers();
          loadBooks();
        }

        // link na Users ‚Äì jen pro ADMIN
        if (user.role === "ROLE_ADMIN") {
          document.getElementById("users-link").classList.remove("hidden");
        }

        loadLoans();
      })
      .catch(() => {
        alert("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatele");
        window.location.href = "login.html";
      });
</script>
</body>
</html>
